@@ -6,7 +6,7 @@ This file contains all of the code to setup the initial MySQL database. (setup.p
 
 */
 
-if( !@mysql_connect( $_DVWA[ 'db_server' ], $_DVWA[ 'db_user' ], $_DVWA[ 'db_password' ] ) ) {
+if( !@($GLOBALS["___mysqli_ston"] = mysqli_connect( $_DVWA[ 'db_server' ],  $_DVWA[ 'db_user' ],  $_DVWA[ 'db_password' ] )) ) {
 	dvwaMessagePush( "Could not connect to the MySQL service.<br />Please check the config file." );
 	dvwaPageReload();
 }
@@ -14,28 +14,28 @@ if( !@mysql_connect( $_DVWA[ 'db_server' ], $_DVWA[ 'db_user' ], $_DVWA[ 'db_pas
 
 // Create database
 $drop_db = "DROP DATABASE IF EXISTS {$_DVWA[ 'db_database' ]};";
-if( !@mysql_query( $drop_db ) ) {
-	dvwaMessagePush( "Could not drop existing database<br />SQL: " . mysql_error() );
+if( !@mysqli_query($GLOBALS["___mysqli_ston"],  $drop_db ) ) {
+	dvwaMessagePush( "Could not drop existing database<br />SQL: " . ((is_object($GLOBALS["___mysqli_ston"])) ? mysqli_error($GLOBALS["___mysqli_ston"]) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : false)) );
 	dvwaPageReload();
 }
 
 $create_db = "CREATE DATABASE {$_DVWA[ 'db_database' ]};";
-if( !@mysql_query( $create_db ) ) {
-	dvwaMessagePush( "Could not create database<br />SQL: " . mysql_error() );
+if( !@mysqli_query($GLOBALS["___mysqli_ston"],  $create_db ) ) {
+	dvwaMessagePush( "Could not create database<br />SQL: " . ((is_object($GLOBALS["___mysqli_ston"])) ? mysqli_error($GLOBALS["___mysqli_ston"]) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : false)) );
 	dvwaPageReload();
 }
 dvwaMessagePush( "Database has been created." );
 
 
 // Create table 'users'
-if( !@mysql_select_db( $_DVWA[ 'db_database' ] ) ) {
+if( !@((bool)mysqli_query($GLOBALS["___mysqli_ston"], "USE " . $_DVWA[ 'db_database' ])) ) {
 	dvwaMessagePush( 'Could not connect to database.' );
 	dvwaPageReload();
 }
 
 $create_tb = "CREATE TABLE users (user_id int(6),first_name varchar(15),last_name varchar(15), user varchar(15), password varchar(32),avatar varchar(70), last_login TIMESTAMP, failed_login INT(3), PRIMARY KEY (user_id));";
-if( !mysql_query( $create_tb ) ) {
-	dvwaMessagePush( "Table could not be created<br />SQL: " . mysql_error() );
+if( !mysqli_query($GLOBALS["___mysqli_ston"],  $create_tb ) ) {
+	dvwaMessagePush( "Table could not be created<br />SQL: " . ((is_object($GLOBALS["___mysqli_ston"])) ? mysqli_error($GLOBALS["___mysqli_ston"]) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : false)) );
 	dvwaPageReload();
 }
 dvwaMessagePush( "'users' table was created." );
@@ -53,8 +53,8 @@ $insert = "INSERT INTO users VALUES
 	('3','Hack','Me','1337',MD5('charley'),'{$baseUrl}1337.jpg', NOW(), '0'),
 	('4','Pablo','Picasso','pablo',MD5('letmein'),'{$baseUrl}pablo.jpg', NOW(), '0'),
 	('5','Bob','Smith','smithy',MD5('password'),'{$baseUrl}smithy.jpg', NOW(), '0');";
-if( !mysql_query( $insert ) ) {
-	dvwaMessagePush( "Data could not be inserted into 'users' table<br />SQL: " . mysql_error() );
+if( !mysqli_query($GLOBALS["___mysqli_ston"],  $insert ) ) {
+	dvwaMessagePush( "Data could not be inserted into 'users' table<br />SQL: " . ((is_object($GLOBALS["___mysqli_ston"])) ? mysqli_error($GLOBALS["___mysqli_ston"]) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : false)) );
 	dvwaPageReload();
 }
 dvwaMessagePush( "Data inserted into 'users' table." );
@@ -62,8 +62,8 @@ dvwaMessagePush( "Data inserted into 'users' table." );
 
 // Create guestbook table
 $create_tb_guestbook = "CREATE TABLE guestbook (comment_id SMALLINT UNSIGNED NOT NULL AUTO_INCREMENT, comment varchar(300), name varchar(100), PRIMARY KEY (comment_id));";
-if( !mysql_query( $create_tb_guestbook ) ) {
-	dvwaMessagePush( "Table could not be created<br />SQL: " . mysql_error() );
+if( !mysqli_query($GLOBALS["___mysqli_ston"],  $create_tb_guestbook ) ) {
+	dvwaMessagePush( "Table could not be created<br />SQL: " . ((is_object($GLOBALS["___mysqli_ston"])) ? mysqli_error($GLOBALS["___mysqli_ston"]) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : false)) );
 	dvwaPageReload();
 }
 dvwaMessagePush( "'guestbook' table was created." );
@@ -71,8 +71,8 @@ dvwaMessagePush( "'guestbook' table was created." );
 
 // Insert data into 'guestbook'
 $insert = "INSERT INTO guestbook VALUES ('1','This is a test comment.','test');";
-if( !mysql_query( $insert ) ) {
-	dvwaMessagePush( "Data could not be inserted into 'guestbook' table<br />SQL: " . mysql_error() );
+if( !mysqli_query($GLOBALS["___mysqli_ston"],  $insert ) ) {
+	dvwaMessagePush( "Data could not be inserted into 'guestbook' table<br />SQL: " . ((is_object($GLOBALS["___mysqli_ston"])) ? mysqli_error($GLOBALS["___mysqli_ston"]) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : false)) );
 	dvwaPageReload();
 }
 dvwaMessagePush( "Data inserted into 'guestbook' table." );
