@@ -929,6 +929,17 @@ static int open_tcp_socket(ares_channel channel, struct server_state *server)
         }
     }
 
+  if (channel->sock_create_cb)
+    {
+      int err = channel->sock_create_cb(s, SOCK_STREAM,
+                                        channel->sock_create_cb_data);
+      if (err < 0)
+        {
+          closesocket(s);
+          return err;
+        }
+    }
+
   SOCK_STATE_CALLBACK(channel, s, 1, 0);
   server->tcp_buffer_pos = 0;
   server->tcp_socket = s;
@@ -969,6 +980,17 @@ static int open_udp_socket(ares_channel channel, struct server_state *server)
         }
     }
 
+  if (channel->sock_create_cb)
+    {
+      int err = channel->sock_create_cb(s, SOCK_DGRAM,
+                                        channel->sock_create_cb_data);
+      if (err < 0)
+        {
+          closesocket(s);
+          return err;
+        }
+    }
+
   SOCK_STATE_CALLBACK(channel, s, 1, 0);
 
   server->udp_socket = s;
