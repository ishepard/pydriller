@@ -21,7 +21,6 @@
  * SPDX-License-Identifier: curl
  *
  ***************************************************************************/
-#define CURL_DISABLE_DEPRECATION  /* Using and testing the form api */
 #include "test.h"
 
 #include "memdebug.h"
@@ -76,23 +75,27 @@ static CURLcode once(char *URL, bool oldstyle)
 
   /* Fill in the file upload field */
   if(oldstyle) {
-    formrc = curl_formadd(&formpost,
-                          &lastptr,
-                          CURLFORM_COPYNAME, "sendfile",
-                          CURLFORM_STREAM, &pooh,
-                          CURLFORM_CONTENTSLENGTH, (long)pooh.sizeleft,
-                          CURLFORM_FILENAME, "postit2.c",
-                          CURLFORM_END);
+    CURL_IGNORE_DEPRECATION(
+      formrc = curl_formadd(&formpost,
+                            &lastptr,
+                            CURLFORM_COPYNAME, "sendfile",
+                            CURLFORM_STREAM, &pooh,
+                            CURLFORM_CONTENTSLENGTH, (long)pooh.sizeleft,
+                            CURLFORM_FILENAME, "postit2.c",
+                            CURLFORM_END);
+    )
   }
   else {
-    /* new style */
-    formrc = curl_formadd(&formpost,
-                          &lastptr,
-                          CURLFORM_COPYNAME, "sendfile alternative",
-                          CURLFORM_STREAM, &pooh,
-                          CURLFORM_CONTENTLEN, (curl_off_t)pooh.sizeleft,
-                          CURLFORM_FILENAME, "file name 2",
-                          CURLFORM_END);
+    CURL_IGNORE_DEPRECATION(
+      /* new style */
+      formrc = curl_formadd(&formpost,
+                            &lastptr,
+                            CURLFORM_COPYNAME, "sendfile alternative",
+                            CURLFORM_STREAM, &pooh,
+                            CURLFORM_CONTENTLEN, (curl_off_t)pooh.sizeleft,
+                            CURLFORM_FILENAME, "file name 2",
+                            CURLFORM_END);
+    )
   }
 
   if(formrc)
@@ -104,52 +107,58 @@ static CURLcode once(char *URL, bool oldstyle)
   pooh2.readptr = data;
   pooh2.sizeleft = strlen(data);
 
-  /* Fill in the file upload field */
-  formrc = curl_formadd(&formpost,
-                        &lastptr,
-                        CURLFORM_COPYNAME, "callbackdata",
-                        CURLFORM_STREAM, &pooh2,
-                        CURLFORM_CONTENTSLENGTH, (long)pooh2.sizeleft,
-                        CURLFORM_END);
-
+  CURL_IGNORE_DEPRECATION(
+    /* Fill in the file upload field */
+    formrc = curl_formadd(&formpost,
+                          &lastptr,
+                          CURLFORM_COPYNAME, "callbackdata",
+                          CURLFORM_STREAM, &pooh2,
+                          CURLFORM_CONTENTSLENGTH, (long)pooh2.sizeleft,
+                          CURLFORM_END);
+  )
   if(formrc)
     printf("curl_formadd(2) = %d\n", (int)formrc);
 
-  /* Fill in the filename field */
-  formrc = curl_formadd(&formpost,
-                        &lastptr,
-                        CURLFORM_COPYNAME, "filename",
-                        CURLFORM_COPYCONTENTS, "postit2.c",
-                        CURLFORM_END);
-
+  CURL_IGNORE_DEPRECATION(
+    /* Fill in the filename field */
+    formrc = curl_formadd(&formpost,
+                          &lastptr,
+                          CURLFORM_COPYNAME, "filename",
+                          CURLFORM_COPYCONTENTS, "postit2.c",
+                          CURLFORM_END);
+  )
   if(formrc)
     printf("curl_formadd(3) = %d\n", (int)formrc);
 
-  /* Fill in a submit field too */
-  formrc = curl_formadd(&formpost,
-                        &lastptr,
-                        CURLFORM_COPYNAME, "submit",
-                        CURLFORM_COPYCONTENTS, "send",
-                        CURLFORM_CONTENTTYPE, "text/plain",
-                        CURLFORM_END);
-
+  CURL_IGNORE_DEPRECATION(
+    /* Fill in a submit field too */
+    formrc = curl_formadd(&formpost,
+                          &lastptr,
+                          CURLFORM_COPYNAME, "submit",
+                          CURLFORM_COPYCONTENTS, "send",
+                          CURLFORM_CONTENTTYPE, "text/plain",
+                          CURLFORM_END);
+  )
   if(formrc)
     printf("curl_formadd(4) = %d\n", (int)formrc);
 
-  formrc = curl_formadd(&formpost, &lastptr,
-                        CURLFORM_COPYNAME, "somename",
-                        CURLFORM_BUFFER, "somefile.txt",
-                        CURLFORM_BUFFERPTR, "blah blah",
-                        CURLFORM_BUFFERLENGTH, (long)9,
-                        CURLFORM_END);
-
+  CURL_IGNORE_DEPRECATION(
+    formrc = curl_formadd(&formpost, &lastptr,
+                          CURLFORM_COPYNAME, "somename",
+                          CURLFORM_BUFFER, "somefile.txt",
+                          CURLFORM_BUFFERPTR, "blah blah",
+                          CURLFORM_BUFFERLENGTH, (long)9,
+                          CURLFORM_END);
+  )
   if(formrc)
     printf("curl_formadd(5) = %d\n", (int)formrc);
 
   curl = curl_easy_init();
   if(!curl) {
     fprintf(stderr, "curl_easy_init() failed\n");
-    curl_formfree(formpost);
+    CURL_IGNORE_DEPRECATION(
+      curl_formfree(formpost);
+    )
     curl_global_cleanup();
     return TEST_ERR_MAJOR_BAD;
   }
@@ -166,8 +175,10 @@ static CURLcode once(char *URL, bool oldstyle)
   /* we want to use our own read function */
   test_setopt(curl, CURLOPT_READFUNCTION, read_callback);
 
-  /* send a multi-part formpost */
-  test_setopt(curl, CURLOPT_HTTPPOST, formpost);
+  CURL_IGNORE_DEPRECATION(
+    /* send a multi-part formpost */
+    test_setopt(curl, CURLOPT_HTTPPOST, formpost);
+  )
 
   /* get verbose debug output please */
   test_setopt(curl, CURLOPT_VERBOSE, 1L);
@@ -180,11 +191,15 @@ static CURLcode once(char *URL, bool oldstyle)
 
 test_cleanup:
 
-  /* always cleanup */
-  curl_easy_cleanup(curl);
+  CURL_IGNORE_DEPRECATION(
+    /* always cleanup */
+    curl_easy_cleanup(curl);
+  )
 
-  /* now cleanup the formpost chain */
-  curl_formfree(formpost);
+  CURL_IGNORE_DEPRECATION(
+    /* now cleanup the formpost chain */
+    curl_formfree(formpost);
+  )
 
   return res;
 }
