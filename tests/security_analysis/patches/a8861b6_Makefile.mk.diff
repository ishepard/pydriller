@@ -22,23 +22,36 @@
 #
 #***************************************************************************
 
-# See usage in lib/Makefile.m32
+# See usage in lib/Makefile.mk
 
 PROOT := ..
 
+### Common
+
+include $(PROOT)/lib/Makefile.mk
+
+### Local
+
 RCFLAGS  += -DCURL_EMBED_MANIFEST
 CPPFLAGS += -I$(PROOT)/lib
 LDFLAGS  += -L$(PROOT)/lib
-LIBS     += -lcurl
+LIBS     := -lcurl $(LIBS)
+
+ifdef WIN32
+  ifneq ($(findstring -dyn,$(CFG)),)
+    DYN := 1
+  endif
+endif
 
-ifneq ($(findstring -dyn,$(CFG)),)
+ifdef DYN
   curl_DEPENDENCIES := $(PROOT)/lib/libcurl$(CURL_DLL_SUFFIX).dll
   curl_DEPENDENCIES += $(PROOT)/lib/libcurl.dll.a
-  DYN := 1
 else
   curl_DEPENDENCIES := $(PROOT)/lib/libcurl.a
-  CPPFLAGS += -DCURL_STATICLIB
-  LDFLAGS += -static
+  ifdef WIN32
+    CPPFLAGS += -DCURL_STATICLIB
+    LDFLAGS += -static
+  endif
 endif
 
 ### Sources and targets
@@ -46,27 +59,53 @@ endif
 # Provides CURL_CFILES, CURLX_CFILES, CURL_RCFILES
 include Makefile.inc
 
-TARGETS := curl.exe
+TARGETS := curl$(BIN_EXT)
 
-curl_OBJECTS := $(patsubst %.c,%.o,$(strip $(CURL_CFILES)))
-curl_OBJECTS += $(patsubst %.c,%.o,$(notdir $(strip $(CURLX_CFILES))))
-curl_OBJECTS += $(patsubst %.rc,%.res,$(strip $(CURL_RCFILES)))
+CURL_CFILES += $(notdir $(CURLX_CFILES))
+
+curl_OBJECTS := $(patsubst %.c,$(OBJ_DIR)/%.o,$(strip $(CURL_CFILES)))
+ifdef WIN32
+curl_OBJECTS += $(patsubst %.rc,$(OBJ_DIR)/%.res,$(strip $(CURL_RCFILES)))
+endif
+ifdef MAP
+CURL_MAP := curl.map
+CURL_LDFLAGS_BIN += -Wl,-Map,$(CURL_MAP)
+TOVCLEAN := $(CURL_MAP)
+endif
 vpath %.c $(PROOT)/lib
 
 TOCLEAN := $(curl_OBJECTS)
+
+### Rules
+
 ifneq ($(wildcard tool_hugehelp.c.cvs),)
+PERL  ?= perl
+NROFF ?= groff
+
 TOCLEAN += tool_hugehelp.c
-endif
 
-### Local rules
+ifneq ($(shell $(WHICH) $(NROFF)),)
+$(PROOT)/docs/curl.1: $(wildcard $(PROOT)/docs/cmdline-opts/*.d)
+	cd $(PROOT)/docs/cmdline-opts && \
+	$(PERL) gen.pl mainpage $(notdir $^) > ../curl.1
 
-$(TARGETS): $(curl_OBJECTS) $(curl_DEPENDENCIES)
-	$(CC) $(LDFLAGS) $(CURL_LDFLAGS_BIN) -o $@ $(curl_OBJECTS) $(LIBS)
+# Necessary for the generated tools_hugehelp.c
+CPPFLAGS += -DUSE_MANUAL
 
+ifdef ZLIB
+_MKHELPOPT += -c
+endif
+tool_hugehelp.c: $(PROOT)/docs/curl.1 mkhelp.pl
+	$(NROFF) -man -Tascii $(MANOPT) $< | \
+	$(PERL) mkhelp.pl $(_MKHELPOPT) $< > $@
+else
 tool_hugehelp.c:
 	@echo Creating $@
 	@$(call COPY, $@.cvs, $@)
+endif
+endif
 
-### Global script
+$(TARGETS): $(curl_OBJECTS) $(curl_DEPENDENCIES)
+	$(CC) $(LDFLAGS) $(CURL_LDFLAGS_BIN) -o $@ $(curl_OBJECTS) $(LIBS)
 
-include $(PROOT)/lib/Makefile.m32
+all: $(OBJ_DIR) $(TARGETS)
